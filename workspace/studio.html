<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚ö° ThunderVerse Studio - AI Game Development Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Mono', 'Monaco', 'Courier New', monospace;
            background: linear-gradient(135deg, #0a0014 0%, #1a0f2e 50%, #0f1419 100%);
            color: #e0e0e0;
            overflow: hidden;
            height: 100vh;
        }

        .studio {
            display: grid;
            grid-template-columns: 280px 1fr 320px;
            grid-template-rows: 60px 1fr 40px;
            height: 100vh;
            gap: 0;
        }

        /* Header */
        .header {
            grid-column: 1 / -1;
            background: rgba(10, 0, 20, 0.9);
            border-bottom: 2px solid #7209b7;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2rem;
            box-shadow: 0 4px 20px rgba(114, 9, 183, 0.3);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo-icon {
            font-size: 2rem;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .logo h1 {
            font-size: 1.5rem;
            background: linear-gradient(135deg, #7209b7, #ff006e, #00f5ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
        }

        .project-name {
            font-size: 1.1rem;
            color: #00f5ff;
        }

        /* Panels */
        .panel {
            background: rgba(26, 15, 46, 0.6);
            border: 1px solid #2d1b4e;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .panel-header {
            background: rgba(10, 0, 20, 0.8);
            padding: 1rem;
            border-bottom: 1px solid #2d1b4e;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-size: 0.9rem;
            color: #00f5ff;
        }

        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        /* Scrollbar styling */
        .panel-content::-webkit-scrollbar {
            width: 8px;
        }

        .panel-content::-webkit-scrollbar-track {
            background: rgba(10, 0, 20, 0.5);
        }

        .panel-content::-webkit-scrollbar-thumb {
            background: #7209b7;
            border-radius: 4px;
        }

        /* Canvas Area */
        .canvas-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            background: rgba(10, 0, 20, 0.3);
        }

        #gameCanvas {
            border: 3px solid #7209b7;
            border-radius: 8px;
            box-shadow: 0 0 40px rgba(114, 9, 183, 0.5);
            background: #1a1a1a;
            image-rendering: pixelated;
        }

        /* Toolbar */
        .toolbar {
            margin-bottom: 1rem;
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .tool-btn {
            padding: 0.5rem 1rem;
            background: rgba(114, 9, 183, 0.3);
            border: 2px solid #7209b7;
            color: #fff;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.85rem;
            text-transform: uppercase;
            font-weight: 600;
        }

        .tool-btn:hover {
            background: rgba(114, 9, 183, 0.6);
            transform: translateY(-2px);
        }

        .tool-btn.active {
            background: #7209b7;
            box-shadow: 0 0 20px rgba(114, 9, 183, 0.8);
        }

        /* Asset Library */
        .asset-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 0.5rem;
        }

        .asset-item {
            width: 60px;
            height: 60px;
            background: rgba(10, 0, 20, 0.7);
            border: 2px solid #2d1b4e;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: grab;
            transition: all 0.3s;
            font-size: 2rem;
        }

        .asset-item:hover {
            border-color: #7209b7;
            transform: scale(1.1);
        }

        .asset-item:active {
            cursor: grabbing;
        }

        .asset-item img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        /* Properties */
        .property-group {
            margin-bottom: 1.5rem;
        }

        .property-label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
            color: #00f5ff;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        input[type="text"],
        input[type="number"],
        input[type="color"],
        select,
        textarea {
            width: 100%;
            padding: 0.5rem;
            background: rgba(10, 0, 20, 0.7);
            border: 1px solid #2d1b4e;
            border-radius: 4px;
            color: #fff;
            font-family: inherit;
            font-size: 0.9rem;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #7209b7;
        }

        .btn {
            width: 100%;
            padding: 0.7rem;
            background: linear-gradient(135deg, #7209b7, #ff006e);
            border: none;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: all 0.3s;
            margin-top: 0.5rem;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(114, 9, 183, 0.6);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #2d1b4e, #1a0f2e);
            border: 1px solid #7209b7;
        }

        /* AI Generation */
        .ai-status {
            margin-top: 1rem;
            padding: 0.7rem;
            background: rgba(0, 245, 255, 0.1);
            border: 1px solid #00f5ff;
            border-radius: 6px;
            font-size: 0.85rem;
            text-align: center;
        }

        .ai-preview {
            margin-top: 1rem;
            text-align: center;
        }

        .ai-preview img {
            max-width: 100%;
            border-radius: 8px;
            border: 2px solid #7209b7;
        }

        /* Footer Status Bar */
        .status-bar {
            grid-column: 1 / -1;
            background: rgba(10, 0, 20, 0.9);
            border-top: 2px solid #7209b7;
            padding: 0 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 0.85rem;
        }

        .status-text {
            color: #00f5ff;
        }

        .health-indicator {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .health-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #00ff00;
            animation: blink 2s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .tab {
            padding: 0.5rem 1rem;
            background: rgba(10, 0, 20, 0.5);
            border: 1px solid #2d1b4e;
            border-radius: 4px 4px 0 0;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab.active {
            background: rgba(114, 9, 183, 0.3);
            border-color: #7209b7;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="studio">
        <!-- Header -->
        <div class="header">
            <div class="logo">
                <span class="logo-icon">‚ö°</span>
                <h1>ThunderVerse Studio</h1>
            </div>
            <div class="project-name" id="projectName">Untitled Project</div>
            <div class="header-actions">
                <button class="tool-btn" onclick="newProject()">New</button>
                <button class="tool-btn" onclick="saveProject()">Save</button>
                <button class="tool-btn" onclick="exportGame()">Export</button>
            </div>
        </div>

        <!-- Left Panel: Asset Library -->
        <div class="panel">
            <div class="panel-header">üì¶ Asset Library</div>
            <div class="panel-content">
                <button class="btn btn-secondary" onclick="openAssetUpload()">Import Assets</button>
                
                <div style="margin-top: 1rem;">
                    <div class="property-label">Emojis</div>
                    <div class="asset-grid" id="emojiLibrary">
                        <!-- Emoji assets will be populated here -->
                    </div>
                </div>

                <div style="margin-top: 1rem;">
                    <div class="property-label">AI Generated</div>
                    <div class="asset-grid" id="aiLibrary">
                        <!-- AI assets will be populated here -->
                    </div>
                </div>

                <div style="margin-top: 1rem;">
                    <div class="property-label">Custom</div>
                    <div class="asset-grid" id="customLibrary">
                        <!-- Custom assets will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Center: Canvas Area -->
        <div class="canvas-area">
            <div class="toolbar">
                <button class="tool-btn active" onclick="setTool('select')" id="toolSelect">Select</button>
                <button class="tool-btn" onclick="setTool('paint')" id="toolPaint">Paint</button>
                <button class="tool-btn" onclick="setTool('erase')" id="toolErase">Erase</button>
                <button class="tool-btn" onclick="toggleGrid()">Grid</button>
                <button class="tool-btn" onclick="clearCanvas()">Clear</button>
            </div>
            <canvas id="gameCanvas" width="800" height="600"></canvas>
        </div>

        <!-- Right Panel: Properties & AI -->
        <div class="panel">
            <div class="panel-header">‚öôÔ∏è Properties & AI</div>
            <div class="panel-content">
                <div class="tabs">
                    <div class="tab active" onclick="switchTab('properties')">Properties</div>
                    <div class="tab" onclick="switchTab('ai')">AI Generate</div>
                </div>

                <!-- Properties Tab -->
                <div id="propertiesTab" class="tab-content active">
                    <div class="property-group">
                        <label class="property-label">Game Name</label>
                        <input type="text" id="gameName" value="My Awesome Game" oninput="updateGameName()">
                    </div>

                    <div class="property-group">
                        <label class="property-label">Canvas Size</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="number" id="canvasWidth" value="800" min="400" max="1920">
                            <input type="number" id="canvasHeight" value="600" min="300" max="1080">
                        </div>
                        <button class="btn btn-secondary" onclick="resizeCanvas()">Apply Size</button>
                    </div>

                    <div class="property-group">
                        <label class="property-label">Background Color</label>
                        <input type="color" id="bgColor" value="#1a1a1a" oninput="updateBackground()">
                    </div>

                    <div class="property-group">
                        <label class="property-label">Grid Size</label>
                        <input type="number" id="gridSize" value="32" min="8" max="128" oninput="updateGrid()">
                    </div>
                </div>

                <!-- AI Generate Tab -->
                <div id="aiTab" class="tab-content">
                    <div class="property-group">
                        <label class="property-label">Describe Your Asset</label>
                        <textarea id="aiPrompt" rows="4" placeholder="e.g., pixelated warrior character, 8-bit style..."></textarea>
                    </div>

                    <div class="property-group">
                        <label class="property-label">Style</label>
                        <select id="aiStyle">
                            <option value="pixel">Pixel Art</option>
                            <option value="cartoon">Cartoon</option>
                            <option value="realistic">Realistic</option>
                            <option value="abstract">Abstract</option>
                        </select>
                    </div>

                    <button class="btn" onclick="generateAIAsset()" id="generateBtn">üé® Generate Asset</button>

                    <div class="ai-status" id="aiStatus" style="display: none;"></div>
                    <div class="ai-preview" id="aiPreview"></div>
                </div>
            </div>
        </div>

        <!-- Status Bar -->
        <div class="status-bar">
            <div class="status-text" id="statusText">Ready</div>
            <div class="health-indicator">
                <span>Server:</span>
                <div class="health-dot" id="healthDot"></div>
                <span id="healthText">Connected</span>
            </div>
        </div>
    </div>

    <script>
        // ==============================================
        // GLOBAL STATE
        // ==============================================
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        let currentProject = {
            id: Date.now().toString(),
            name: 'Untitled Project',
            canvas: {
                width: 800,
                height: 600,
                background: '#1a1a1a'
            },
            assets: [], // [{id, type, x, y, width, height, image, emoji}]
            gridSize: 32
        };

        let currentTool = 'select';
        let showGrid = false;
        let selectedAsset = null;
        let isDragging = false;
        let dragOffset = { x: 0, y: 0 };

        // Server config
        const SERVER_URL = 'http://localhost:3001';

        // ==============================================
        // INITIALIZATION
        // ==============================================
        function init() {
            populateEmojiLibrary();
            checkServerHealth();
            setupCanvasEvents();
            updateBackground();
            updateStatus('ThunderVerse Studio Ready ‚ö°');
            
            // Check for saved projects
            const savedProjects = getAllSavedProjects();
            if (savedProjects.length > 0) {
                updateStatus(`Found ${savedProjects.length} saved project(s)`);
            }
        }

        function populateEmojiLibrary() {
            const emojis = ['üëæ', 'üéÆ', 'üèÜ', 'üíé', '‚≠ê', 'üî•', 'üí£', 'üó°Ô∏è', 'üõ°Ô∏è', 'üéØ', 'üöÄ', 'üåü'];
            const library = document.getElementById('emojiLibrary');
            
            emojis.forEach(emoji => {
                const div = document.createElement('div');
                div.className = 'asset-item';
                div.textContent = emoji;
                div.draggable = true;
                div.dataset.type = 'emoji';
                div.dataset.icon = emoji;
                
                div.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('type', 'emoji');
                    e.dataTransfer.setData('icon', emoji);
                });
                
                library.appendChild(div);
            });
        }

        // ==============================================
        // CANVAS MANAGEMENT
        // ==============================================
        function setupCanvasEvents() {
            canvas.addEventListener('dragover', (e) => e.preventDefault());
            
            canvas.addEventListener('drop', (e) => {
                e.preventDefault();
                
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                const type = e.dataTransfer.getData('type');
                const icon = e.dataTransfer.getData('icon');
                const imageUrl = e.dataTransfer.getData('imageUrl');
                
                const asset = {
                    id: Date.now(),
                    type: type,
                    x: showGrid ? Math.floor(x / currentProject.gridSize) * currentProject.gridSize : x,
                    y: showGrid ? Math.floor(y / currentProject.gridSize) * currentProject.gridSize : y,
                    width: imageUrl ? 64 : 32,
                    height: imageUrl ? 64 : 32,
                    image: imageUrl || null,
                    emoji: icon || null
                };
                
                currentProject.assets.push(asset);
                redrawCanvas();
                updateStatus(`Added ${type} asset to canvas`);
            });

            // Select tool events
            canvas.addEventListener('mousedown', (e) => {
                if (currentTool !== 'select') return;
                
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                // Find clicked asset (reverse order to get top asset)
                selectedAsset = null;
                for (let i = currentProject.assets.length - 1; i >= 0; i--) {
                    const asset = currentProject.assets[i];
                    if (x >= asset.x && x <= asset.x + asset.width &&
                        y >= asset.y && y <= asset.y + asset.height) {
                        selectedAsset = asset;
                        isDragging = true;
                        dragOffset = { x: x - asset.x, y: y - asset.y };
                        break;
                    }
                }
                
                redrawCanvas();
            });

            canvas.addEventListener('mousemove', (e) => {
                if (!isDragging || !selectedAsset) return;
                
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left - dragOffset.x;
                const y = e.clientY - rect.top - dragOffset.y;
                
                selectedAsset.x = showGrid ? Math.floor(x / currentProject.gridSize) * currentProject.gridSize : x;
                selectedAsset.y = showGrid ? Math.floor(y / currentProject.gridSize) * currentProject.gridSize : y;
                
                redrawCanvas();
            });

            canvas.addEventListener('mouseup', () => {
                isDragging = false;
            });

            // Delete key support
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Delete' && selectedAsset) {
                    currentProject.assets = currentProject.assets.filter(a => a.id !== selectedAsset.id);
                    selectedAsset = null;
                    redrawCanvas();
                    updateStatus('Deleted asset');
                }
            });
        }

        function renderAsset(asset) {
            if (asset.emoji) {
                ctx.font = `${asset.height}px Arial`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(asset.emoji, asset.x + asset.width / 2, asset.y + asset.height / 2);
            } else if (asset.image) {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                img.onload = () => {
                    ctx.drawImage(img, asset.x, asset.y, asset.width, asset.height);
                    
                    // Draw selection if selected
                    if (selectedAsset && selectedAsset.id === asset.id) {
                        ctx.strokeStyle = '#00f5ff';
                        ctx.lineWidth = 2;
                        ctx.strokeRect(asset.x - 2, asset.y - 2, asset.width + 4, asset.height + 4);
                    }
                };
                img.onerror = () => {
                    console.error('Failed to load image:', asset.image);
                    // Draw placeholder
                    ctx.fillStyle = '#ff006e';
                    ctx.fillRect(asset.x, asset.y, asset.width, asset.height);
                };
                img.src = asset.image;
            }
            
            // Draw selection box
            if (selectedAsset && selectedAsset.id === asset.id && asset.emoji) {
                ctx.strokeStyle = '#00f5ff';
                ctx.lineWidth = 2;
                ctx.strokeRect(asset.x - 2, asset.y - 2, asset.width + 4, asset.height + 4);
            }
        }

        function redrawCanvas() {
            // Clear canvas
            ctx.fillStyle = currentProject.canvas.background;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw grid if enabled
            if (showGrid) {
                drawGrid();
            }
            
            // Render all assets
            currentProject.assets.forEach(asset => renderAsset(asset));
        }

        function drawGrid() {
            const gridSize = currentProject.gridSize;
            ctx.strokeStyle = 'rgba(114, 9, 183, 0.2)';
            ctx.lineWidth = 1;
            
            for (let x = 0; x < canvas.width; x += gridSize) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
            }
            
            for (let y = 0; y < canvas.height; y += gridSize) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
            }
        }

        function toggleGrid() {
            showGrid = !showGrid;
            redrawCanvas();
            updateStatus(`Grid ${showGrid ? 'enabled' : 'disabled'}`);
        }

        function clearCanvas() {
            if (confirm('Clear all assets from canvas?')) {
                currentProject.assets = [];
                selectedAsset = null;
                redrawCanvas();
                updateStatus('Canvas cleared');
            }
        }

        function updateBackground() {
            const color = document.getElementById('bgColor').value;
            currentProject.canvas.background = color;
            redrawCanvas();
        }

        function resizeCanvas() {
            const width = parseInt(document.getElementById('canvasWidth').value);
            const height = parseInt(document.getElementById('canvasHeight').value);
            
            canvas.width = width;
            canvas.height = height;
            currentProject.canvas.width = width;
            currentProject.canvas.height = height;
            
            redrawCanvas();
            updateStatus(`Canvas resized to ${width}x${height}`);
        }

        function updateGrid() {
            currentProject.gridSize = parseInt(document.getElementById('gridSize').value);
            if (showGrid) {
                redrawCanvas();
            }
        }

        // ==============================================
        // TOOL MANAGEMENT
        // ==============================================
        function setTool(tool) {
            currentTool = tool;
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`tool${tool.charAt(0).toUpperCase() + tool.slice(1)}`).classList.add('active');
            updateStatus(`Tool: ${tool}`);
        }

        // ==============================================
        // PROJECT MANAGEMENT
        // ==============================================
        function newProject() {
            if (confirm('Create new project? Unsaved changes will be lost.')) {
                currentProject = {
                    id: Date.now().toString(),
                    name: 'Untitled Project',
                    canvas: {
                        width: 800,
                        height: 600,
                        background: '#1a1a1a'
                    },
                    assets: [],
                    gridSize: 32
                };
                
                document.getElementById('projectName').textContent = 'Untitled Project';
                document.getElementById('gameName').value = 'My Awesome Game';
                selectedAsset = null;
                redrawCanvas();
                updateStatus('New project created');
            }
        }

        function saveProject() {
            const key = `thunderverse_project_${currentProject.id}`;
            localStorage.setItem(key, JSON.stringify(currentProject));
            
            // Save project list
            let projectList = JSON.parse(localStorage.getItem('thunderverse_projects') || '[]');
            if (!projectList.includes(currentProject.id)) {
                projectList.push(currentProject.id);
                localStorage.setItem('thunderverse_projects', JSON.stringify(projectList));
            }
            
            updateStatus(`‚úÖ Project saved: ${currentProject.name}`);
        }

        function loadProject(projectId) {
            updateStatus('Loading project: ' + projectId);
            
            const key = `thunderverse_project_${projectId}`;
            const data = localStorage.getItem(key);
            
            if (data) {
                currentProject = JSON.parse(data);
                document.getElementById('projectName').textContent = currentProject.name;
                document.getElementById('gameName').value = currentProject.name;
                document.getElementById('canvasWidth').value = currentProject.canvas.width;
                document.getElementById('canvasHeight').value = currentProject.canvas.height;
                document.getElementById('bgColor').value = currentProject.canvas.background;
                document.getElementById('gridSize').value = currentProject.gridSize;
                
                canvas.width = currentProject.canvas.width;
                canvas.height = currentProject.canvas.height;
                
                redrawCanvas();
                updateStatus(`‚úÖ Loaded: ${currentProject.name}`);
            } else {
                updateStatus(`‚ùå Project not found: ${projectId}`);
            }
        }

        function getAllSavedProjects() {
            return JSON.parse(localStorage.getItem('thunderverse_projects') || '[]');
        }

        function updateGameName() {
            const name = document.getElementById('gameName').value;
            currentProject.name = name;
            document.getElementById('projectName').textContent = name;
        }

        // ==============================================
        // ASSET IMPORT
        // ==============================================
        function openAssetUpload() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.multiple = true;
            
            input.onchange = async (e) => {
                const files = Array.from(e.target.files);
                updateStatus(`Importing ${files.length} asset(s)...`);
                
                for (const file of files) {
                    const dataUrl = await readFileAsDataURL(file);
                    addCustomAssetToLibrary(file.name, dataUrl);
                }
                
                updateStatus(`‚úÖ Imported ${files.length} assets`);
            };
            
            input.click();
        }

        function readFileAsDataURL(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function addCustomAssetToLibrary(name, dataUrl) {
            const library = document.getElementById('customLibrary');
            const div = document.createElement('div');
            div.className = 'asset-item';
            div.draggable = true;
            div.dataset.type = 'custom';
            div.title = name;
            
            const img = document.createElement('img');
            img.src = dataUrl;
            div.appendChild(img);
            
            div.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('type', 'custom');
                e.dataTransfer.setData('imageUrl', dataUrl);
            });
            
            library.appendChild(div);
        }

        // ==============================================
        // EXPORT GAME
        // ==============================================
        function exportGame() {
            updateStatus('Exporting game...');
            
            // Capture canvas as data URL
            const canvasData = canvas.toDataURL('image/png');
            
            // Generate HTML template
            const html = generateGameHTML({
                name: currentProject.name,
                canvasData: canvasData,
                assets: currentProject.assets,
                width: canvas.width,
                height: canvas.height,
                background: currentProject.canvas.background
            });
            
            // Download file
            downloadFile(html, sanitizeFilename(currentProject.name) + '.html', 'text/html');
            updateStatus(`‚úÖ Exported: ${currentProject.name}.html`);
        }

        function generateGameHTML(config) {
            return `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${config.name}</title>
    <style>
        body {
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #0a0014, #1a0f2e);
            font-family: monospace;
            color: white;
        }
        .container {
            text-align: center;
        }
        h1 {
            background: linear-gradient(135deg, #7209b7, #ff006e, #00f5ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 1rem;
        }
        canvas {
            border: 3px solid #7209b7;
            border-radius: 8px;
            box-shadow: 0 0 40px rgba(114, 9, 183, 0.5);
        }
        .credit {
            margin-top: 1rem;
            opacity: 0.7;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>${config.name}</h1>
        <canvas id="game" width="${config.width}" height="${config.height}"></canvas>
        <div class="credit">Created with ‚ö° ThunderVerse Studio</div>
    </div>
    <script>
        const canvas = document.getElementById('game');
        const ctx = canvas.getContext('2d');
        
        // Draw the exported canvas image
        const img = new Image();
        img.onload = () => {
            ctx.drawImage(img, 0, 0);
        };
        img.src = '${config.canvasData}';
        
        // Game data
        const gameData = ${JSON.stringify(config.assets)};
        
        // Add your game logic here...
    </script>
</body>
</html>`;
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function sanitizeFilename(name) {
            return name.replace(/[^a-z0-9]/gi, '_').toLowerCase();
        }

        // ==============================================
        // AI GENERATION
        // ==============================================
        async function generateAIAsset() {
            const prompt = document.getElementById('aiPrompt').value.trim();
            const style = document.getElementById('aiStyle').value;
            
            if (!prompt) {
                alert('Please enter a prompt');
                return;
            }
            
            const statusEl = document.getElementById('aiStatus');
            const previewEl = document.getElementById('aiPreview');
            const generateBtn = document.getElementById('generateBtn');
            
            statusEl.style.display = 'block';
            statusEl.textContent = 'üé® Generating with AI...';
            generateBtn.disabled = true;
            previewEl.innerHTML = '';
            
            try {
                const response = await fetch(`${SERVER_URL}/api/image/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: `${prompt}, ${style} art style`, style })
                });
                
                if (!response.ok) throw new Error('Generation failed');
                
                const data = await response.json();
                statusEl.textContent = '‚úÖ Generated successfully!';
                
                // Show preview
                const img = document.createElement('img');
                img.src = data.imageUrl;
                img.style.maxWidth = '100%';
                previewEl.appendChild(img);
                
                // Add to library
                const button = document.createElement('button');
                button.className = 'btn';
                button.textContent = 'Add to Library';
                button.onclick = () => addAIAssetToLibrary(data.imageUrl);
                previewEl.appendChild(button);
                
            } catch (error) {
                statusEl.textContent = '‚ùå Generation failed: ' + error.message;
            } finally {
                generateBtn.disabled = false;
            }
        }

        function addAIAssetToLibrary(imageUrl) {
            const library = document.getElementById('aiLibrary');
            const div = document.createElement('div');
            div.className = 'asset-item';
            div.draggable = true;
            div.dataset.type = 'ai';
            
            const img = document.createElement('img');
            img.src = imageUrl;
            div.appendChild(img);
            
            div.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('type', 'ai');
                e.dataTransfer.setData('imageUrl', imageUrl);
            });
            
            library.appendChild(div);
            updateStatus('‚úÖ AI asset added to library');
        }

        // ==============================================
        // UI HELPERS
        // ==============================================
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tab + 'Tab').classList.add('active');
        }

        function updateStatus(message) {
            document.getElementById('statusText').textContent = message;
        }

        // ==============================================
        // SERVER HEALTH CHECK
        // ==============================================
        async function checkServerHealth() {
            try {
                const response = await fetch(`${SERVER_URL}/api/health`);
                if (response.ok) {
                    document.getElementById('healthDot').style.background = '#00ff00';
                    document.getElementById('healthText').textContent = 'Connected';
                } else {
                    throw new Error('Server unhealthy');
                }
            } catch (error) {
                document.getElementById('healthDot').style.background = '#ff0000';
                document.getElementById('healthText').textContent = 'Disconnected';
                console.error('Server health check failed:', error);
            }
        }

        // Check health every 30 seconds
        setInterval(checkServerHealth, 30000);

        // ==============================================
        // START
        // ==============================================
        window.addEventListener('load', init);
    </script>
</body>
</html>
