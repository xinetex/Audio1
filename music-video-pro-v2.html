<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Video Director Pro V2</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/meyda/5.6.0/meyda.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000;
            color: #fff;
            overflow: hidden;
        }
        #canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        #ingredientCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
        }
        #ui {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
            z-index: 10;
        }
        #upload-area {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 3px dashed rgba(102, 126, 234, 0.5);
            border-radius: 25px;
            padding: 4rem 5rem;
            text-align: center;
            pointer-events: all;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #upload-area:hover { 
            border-color: #667eea; 
            background: rgba(102, 126, 234, 0.15);
            transform: scale(1.02);
        }
        #upload-area.hidden { display: none; }
        h1 { 
            font-size: 2.5rem; 
            margin-bottom: 1rem; 
            background: linear-gradient(135deg, #667eea, #764ba2, #f093fb);
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent;
            font-weight: 800;
        }
        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 0.5rem;
        }
        #controls {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(20px);
            padding: 1.5rem;
            border-radius: 25px;
            border: 1px solid rgba(102, 126, 234, 0.3);
            display: none;
            z-index: 20;
            max-height: 50vh;
            overflow-y: auto;
        }
        #controls.show { display: block; }
        .control-row {
            display: flex;
            gap: 1rem;
            align-items: center;
            margin-bottom: 1rem;
        }
        .control-row:last-child { margin-bottom: 0; }
        button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
            font-weight: 600;
            white-space: nowrap;
        }
        button:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }
        button.recording { 
            background: linear-gradient(135deg, #f44336, #e91e63);
            animation: pulse 1.5s ease-in-out infinite;
        }
        @keyframes pulse { 
            0%, 100% { opacity: 1; box-shadow: 0 0 20px rgba(244, 67, 54, 0.5); } 
            50% { opacity: 0.8; box-shadow: 0 0 40px rgba(244, 67, 54, 0.8); } 
        }
        .slider-group {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            min-width: 200px;
        }
        .slider-group label {
            min-width: 110px;
            font-size: 0.8rem;
            opacity: 0.9;
        }
        input[type="range"] {
            flex: 1;
            height: 8px;
            border-radius: 4px;
            background: linear-gradient(90deg, rgba(102, 126, 234, 0.3), rgba(240, 147, 251, 0.3));
            outline: none;
            -webkit-appearance: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #f093fb);
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(102, 126, 234, 0.6);
        }
        .value {
            min-width: 35px;
            text-align: right;
            font-size: 0.75rem;
            opacity: 0.8;
            font-weight: 600;
        }
        select {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 10px;
            font-size: 0.9rem;
            cursor: pointer;
        }
        .section-title {
            font-size: 0.9rem;
            font-weight: 700;
            margin: 1rem 0 0.5rem 0;
            padding-top: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            background: linear-gradient(135deg, #667eea, #f093fb);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .section-title:first-child {
            margin-top: 0;
            padding-top: 0;
            border-top: none;
        }
        #analysisPanel {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(20px);
            padding: 1.5rem;
            border-radius: 20px;
            border: 1px solid rgba(102, 126, 234, 0.3);
            z-index: 25;
            max-width: 320px;
            display: none;
        }
        #analysisPanel.show { display: block; }
        #analysisPanel h3 {
            font-size: 1.1rem;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, #667eea, #f093fb);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 700;
        }
        .analysis-item {
            margin-bottom: 0.75rem;
            font-size: 0.85rem;
            display: flex;
            justify-content: space-between;
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }
        .analysis-label {
            opacity: 0.7;
        }
        .analysis-value {
            font-weight: 600;
            color: #667eea;
        }
        #sceneInfo {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(20px);
            padding: 1rem 1.5rem;
            border-radius: 20px;
            border: 1px solid rgba(102, 126, 234, 0.3);
            z-index: 25;
            text-align: center;
            display: none;
        }
        #sceneInfo.show { display: block; }
        #sceneTitle {
            font-size: 1.2rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea, #f093fb);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
        }
        #sceneDesc {
            font-size: 0.85rem;
            opacity: 0.7;
        }
        .progress-bar {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 0.5rem;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #f093fb);
            width: 0%;
            transition: width 0.3s ease;
        }
        #visualizer {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 2px;
            align-items: flex-end;
            height: 60px;
            display: none;
        }
        #visualizer.show { display: flex; }
        .freq-bar {
            width: 3px;
            background: linear-gradient(180deg, #f093fb, #667eea);
            border-radius: 2px;
            transition: height 0.05s ease;
        }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    <canvas id="ingredientCanvas"></canvas>
    
    <div id="sceneInfo">
        <div id="sceneTitle">Ready</div>
        <div id="sceneDesc">Upload audio to begin</div>
        <div class="progress-bar">
            <div class="progress-fill" id="sceneProgress"></div>
        </div>
    </div>
    
    <div id="analysisPanel">
        <h3>üéµ Audio Intelligence</h3>
        <div class="analysis-item">
            <span class="analysis-label">Tempo</span>
            <span class="analysis-value" id="tempoValue">-- BPM</span>
        </div>
        <div class="analysis-item">
            <span class="analysis-label">Key</span>
            <span class="analysis-value" id="keyValue">--</span>
        </div>
        <div class="analysis-item">
            <span class="analysis-label">Energy</span>
            <span class="analysis-value" id="energyValue">--</span>
        </div>
        <div class="analysis-item">
            <span class="analysis-label">Brightness</span>
            <span class="analysis-value" id="brightnessValue">--</span>
        </div>
        <div class="analysis-item">
            <span class="analysis-label">Spectral Flux</span>
            <span class="analysis-value" id="fluxValue">--</span>
        </div>
        <div class="analysis-item">
            <span class="analysis-label">RMS</span>
            <span class="analysis-value" id="rmsValue">--</span>
        </div>
    </div>
    
    <div id="visualizer"></div>
    
    <div id="ui">
        <div id="upload-area">
            <h1>üé¨ Music Video Director Pro V2</h1>
            <p class="subtitle">Advanced audio analysis ‚Ä¢ Deep visual control</p>
            <input type="file" id="fileInput" accept="audio/*" style="display: none;">
        </div>
    </div>
    
    <div id="controls">
        <div class="control-row">
            <button id="playBtn">‚ñ∂Ô∏è Play</button>
            <button id="recordBtn">‚è∫Ô∏è Record</button>
            <button id="downloadBtn" style="display:none;">üíæ Download</button>
            <button id="analysisBtn">üéµ Analysis</button>
            <button id="toggleVisualizerBtn">üìä Spectrum</button>
            <select id="sceneSelect">
                <option value="0">Scene 1: Cosmic Tunnel</option>
                <option value="1">Scene 2: Particle Storm</option>
                <option value="2">Scene 3: Fractal Energy</option>
                <option value="3">Scene 4: Liquid Plasma</option>
                <option value="4">Scene 5: Kaleidoscope</option>
                <option value="5">Scene 6: Warp Speed</option>
                <option value="6">Scene 7: Energy Field</option>
                <option value="7">Scene 8: Vortex</option>
            </select>
        </div>
        
        <div class="section-title">üöÄ Camera & Motion</div>
        <div class="control-row">
            <div class="slider-group">
                <label>Zoom Speed</label>
                <input type="range" id="zoomSpeed" min="0" max="100" value="60">
                <span class="value" id="zoomSpeedVal">60</span>
            </div>
            <div class="slider-group">
                <label>Rotation</label>
                <input type="range" id="rotation" min="0" max="100" value="30">
                <span class="value" id="rotationVal">30</span>
            </div>
        </div>
        
        <div class="section-title">üé® Visual Aesthetics</div>
        <div class="control-row">
            <div class="slider-group">
                <label>Color Hue</label>
                <input type="range" id="colorShift" min="0" max="100" value="50">
                <span class="value" id="colorShiftVal">50</span>
            </div>
            <div class="slider-group">
                <label>Saturation</label>
                <input type="range" id="saturation" min="0" max="100" value="80">
                <span class="value" id="saturationVal">80</span>
            </div>
        </div>
        <div class="control-row">
            <div class="slider-group">
                <label>Brightness</label>
                <input type="range" id="brightness" min="0" max="100" value="70">
                <span class="value" id="brightnessVal">70</span>
            </div>
            <div class="slider-group">
                <label>Contrast</label>
                <input type="range" id="contrast" min="0" max="100" value="60">
                <span class="value" id="contrastVal">60</span>
            </div>
        </div>
        
        <div class="section-title">‚ö° Audio Reactivity</div>
        <div class="control-row">
            <div class="slider-group">
                <label>Bass Response</label>
                <input type="range" id="bassReact" min="0" max="100" value="70">
                <span class="value" id="bassReactVal">70</span>
            </div>
            <div class="slider-group">
                <label>Mid Response</label>
                <input type="range" id="midReact" min="0" max="100" value="50">
                <span class="value" id="midReactVal">50</span>
            </div>
        </div>
        <div class="control-row">
            <div class="slider-group">
                <label>Treble Response</label>
                <input type="range" id="trebleReact" min="0" max="100" value="40">
                <span class="value" id="trebleReactVal">40</span>
            </div>
            <div class="slider-group">
                <label>Beat Sensitivity</label>
                <input type="range" id="beatSensitivity" min="0" max="100" value="60">
                <span class="value" id="beatSensitivityVal">60</span>
            </div>
        </div>
        
        <div class="section-title">üí´ Effect Parameters</div>
        <div class="control-row">
            <div class="slider-group">
                <label>Complexity</label>
                <input type="range" id="complexity" min="0" max="100" value="65">
                <span class="value" id="complexityVal">65</span>
            </div>
            <div class="slider-group">
                <label>Intensity</label>
                <input type="range" id="intensity" min="0" max="100" value="70">
                <span class="value" id="intensityVal">70</span>
            </div>
        </div>
        <div class="control-row">
            <div class="slider-group">
                <label>Detail Level</label>
                <input type="range" id="detail" min="0" max="100" value="60">
                <span class="value" id="detailVal">60</span>
            </div>
            <div class="slider-group">
                <label>Motion Blur</label>
                <input type="range" id="motionBlur" min="0" max="100" value="20">
                <span class="value" id="motionBlurVal">20</span>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const gl = canvas.getContext('webgl2', { preserveDrawingBuffer: true });
        const ingredientCanvas = document.getElementById('ingredientCanvas');
        const ctx2d = ingredientCanvas.getContext('2d');
        const uploadArea = document.getElementById('upload-area');
        const fileInput = document.getElementById('fileInput');
        const controls = document.getElementById('controls');
        const playBtn = document.getElementById('playBtn');
        const recordBtn = document.getElementById('recordBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const analysisBtn = document.getElementById('analysisBtn');
        const toggleVisualizerBtn = document.getElementById('toggleVisualizerBtn');
        const analysisPanel = document.getElementById('analysisPanel');
        const sceneInfo = document.getElementById('sceneInfo');
        const visualizer = document.getElementById('visualizer');
        const sceneSelect = document.getElementById('sceneSelect');

        let audioContext, analyser, source, audioBuffer, meydaAnalyzer;
        let isPlaying = false;
        let mediaRecorder, recordedChunks = [];
        let startTime = 0;
        let currentTime = 0;
        let currentScene = 0;
        
        let params = {
            zoomSpeed: 0.6,
            rotation: 0.3,
            colorShift: 0.5,
            saturation: 0.8,
            brightness: 0.7,
            contrast: 0.6,
            bassReact: 0.7,
            midReact: 0.5,
            trebleReact: 0.4,
            beatSensitivity: 0.6,
            complexity: 0.65,
            intensity: 0.7,
            detail: 0.6,
            motionBlur: 0.2
        };

        // Audio analysis state
        let audioFeatures = {
            rms: 0,
            energy: 0,
            spectralCentroid: 0,
            spectralFlux: 0,
            zcr: 0,
            chroma: [],
            bass: 0,
            mid: 0,
            treble: 0,
            tempo: 120
        };

        let beatHistory = [];
        let lastBeat = 0;

        // Resize canvas
        function resize() {
            canvas.width = ingredientCanvas.width = window.innerWidth;
            canvas.height = ingredientCanvas.height = window.innerHeight;
            gl.viewport(0, 0, canvas.width, canvas.height);
            
            // Create visualizer bars
            const visualizerEl = document.getElementById('visualizer');
            visualizerEl.innerHTML = '';
            for (let i = 0; i < 128; i++) {
                const bar = document.createElement('div');
                bar.className = 'freq-bar';
                bar.style.height = '5px';
                visualizerEl.appendChild(bar);
            }
        }
        window.addEventListener('resize', resize);
        resize();

        // Setup sliders
        Object.keys(params).forEach(id => {
            const slider = document.getElementById(id);
            if (!slider) return;
            const valueSpan = document.getElementById(id + 'Val');
            slider.addEventListener('input', (e) => {
                const val = e.target.value;
                valueSpan.textContent = val;
                params[id] = val / 100;
            });
        });

        // Toggle panels
        analysisBtn.addEventListener('click', () => {
            analysisPanel.classList.toggle('show');
        });
        
        toggleVisualizerBtn.addEventListener('click', () => {
            visualizer.classList.toggle('show');
        });

        sceneSelect.addEventListener('change', (e) => {
            currentScene = parseInt(e.target.value);
        });

        // Advanced shaders with MORE parameters
        const advancedShaders = [
            // 0: Cosmic Tunnel
            `precision highp float;
            uniform vec2 resolution;
            uniform float time, bass, mid, treble, zoom, rotation, colorShift, saturation, brightness, contrast, complexity, intensity, detail;
            
            void main() {
                vec2 uv = (gl_FragCoord.xy - resolution.xy * 0.5) / resolution.y;
                float z = zoom * 5.0 + bass * params.bassReact * 3.0;
                uv /= z;
                uv.x += time * 0.2 * (rotation + 0.3);
                
                float angle = atan(uv.y, uv.x) + rotation * time;
                float dist = length(uv);
                
                float tunnel = 0.0;
                for(float i = 1.0; i <= 8.0; i++) {
                    if(i > 3.0 + detail * 5.0) break;
                    tunnel += sin(dist * 15.0 * i * complexity - time * 2.0 * i + bass * 3.0) / i;
                    tunnel += sin(angle * 8.0 * i + time + mid * 2.0) / i;
                }
                tunnel *= intensity * 0.5;
                
                vec3 col = vec3(
                    0.5 + sin(tunnel + colorShift * 6.28 + dist * 2.0) * saturation,
                    0.5 + sin(tunnel + colorShift * 6.28 + 2.09) * saturation,
                    0.5 + sin(tunnel + colorShift * 6.28 + 4.19) * saturation
                );
                
                col *= brightness;
                col = mix(vec3(0.5), col, contrast);
                col *= (1.0 - dist * 0.5);
                col += bass * params.bassReact * 0.3;
                
                gl_FragColor = vec4(col, 1.0);
            }`.replace(/params\./g, ''),
            
            // 1: Particle Storm
            `precision highp float;
            uniform vec2 resolution;
            uniform float time, bass, mid, treble, zoom, rotation, colorShift, saturation, brightness, contrast, complexity, intensity;
            
            float hash(vec2 p) {
                return fract(sin(dot(p, vec2(127.1, 311.7))) * 43758.5453);
            }
            
            void main() {
                vec2 uv = (gl_FragCoord.xy - resolution.xy * 0.5) / resolution.y;
                vec3 col = vec3(0.0);
                
                float particleCount = 50.0 + complexity * 150.0;
                float speed = zoom * 2.0 + bass * 1.5;
                
                for(float i = 0.0; i < 200.0; i++) {
                    if(i >= particleCount) break;
                    vec2 pos = vec2(hash(vec2(i, 0.0)) - 0.5, hash(vec2(i, 1.0)) - 0.5) * 2.0;
                    float depth = hash(vec2(i, 2.0));
                    float t = mod(time * speed * (0.5 + depth), 10.0);
                    float angle = t + i * 0.1 + rotation * 10.0;
                    float radius = t * 0.1 * depth;
                    pos += vec2(cos(angle), sin(angle)) * radius;
                    pos.x += sin(t * 3.0 + mid * 5.0) * 0.2;
                    pos.y += cos(t * 2.0 + bass * 5.0) * 0.2;
                    float d = length(uv - pos);
                    float bright = 0.005 / d * intensity * (1.0 - depth * 0.5);
                    vec3 particleColor = vec3(
                        0.5 + sin(i * 0.1 + colorShift * 6.28 + time) * saturation,
                        0.5 + sin(i * 0.13 + time * 1.3) * saturation,
                        0.5 + sin(i * 0.17 + treble) * saturation
                    );
                    col += particleColor * bright;
                }
                
                col *= brightness;
                col = mix(vec3(0.5), col, contrast);
                gl_FragColor = vec4(col, 1.0);
            }`,
            
            // 2: Fractal Energy
            `precision highp float;
            uniform vec2 resolution;
            uniform float time, bass, mid, treble, zoom, rotation, colorShift, saturation, brightness, contrast, complexity, intensity, detail;
            
            void main() {
                vec2 uv = (gl_FragCoord.xy - resolution.xy * 0.5) / resolution.y;
                float scale = 1.0 / (zoom * 3.0 + bass * 0.5);
                uv *= scale;
                uv += vec2(cos(time * 0.2) * 0.3, sin(time * 0.15) * 0.3);
                float a = rotation * 3.14 + time * 0.3;
                float c = cos(a), s = sin(a);
                uv = vec2(uv.x * c - uv.y * s, uv.x * s + uv.y * c);
                
                vec2 z = uv;
                float iter = 0.0;
                float maxIter = 32.0 + detail * 64.0;
                
                for(float i = 0.0; i < 96.0; i++) {
                    if(i >= maxIter || length(z) > 4.0) break;
                    z = vec2(z.x*z.x - z.y*z.y, 2.0*z.x*z.y) + uv;
                    iter = i;
                }
                
                float val = iter / maxIter * intensity;
                val += sin(time + mid * 3.0) * 0.2;
                
                vec3 col = vec3(
                    sin(val * 6.0 + colorShift * 6.28 + bass * 2.0) * saturation + 0.5,
                    sin(val * 6.0 + colorShift * 6.28 + 2.09 + mid) * saturation + 0.5,
                    sin(val * 6.0 + colorShift * 6.28 + 4.19 + treble) * saturation + 0.5
                );
                
                col = pow(col, vec3(1.2));
                col *= brightness;
                col = mix(vec3(0.5), col, contrast);
                col += bass * 0.3;
                
                gl_FragColor = vec4(col, 1.0);
            }`,
            
            // 3: Liquid Plasma
            `precision highp float;
            uniform vec2 resolution;
            uniform float time, bass, mid, treble, zoom, rotation, colorShift, saturation, brightness, contrast, complexity, intensity;
            
            void main() {
                vec2 uv = gl_FragCoord.xy / resolution.xy;
                vec2 p = uv * 2.0 - 1.0;
                p.x *= resolution.x / resolution.y;
                float t = time * zoom * 0.5;
                
                for(float i = 0.0; i < 8.0; i++) {
                    if(i >= 3.0 + complexity * 5.0) break;
                    p.x += sin(p.y * (3.0 + i) + t + bass * 2.0) * intensity * 0.1;
                    p.y += cos(p.x * (3.0 + i) + t * 1.3 + mid * 2.0) * intensity * 0.1;
                }
                
                float len = length(p);
                vec3 col = vec3(
                    sin(len * 4.0 + t + colorShift * 6.28 + bass) * saturation + 0.5,
                    sin(len * 5.0 + t * 1.3 + mid) * saturation + 0.5,
                    sin(len * 6.0 + t * 1.7 + treble) * saturation + 0.5
                );
                
                col = pow(col, vec3(1.3));
                col *= brightness * (1.5 - len * 0.5);
                col = mix(vec3(0.5), col, contrast);
                
                gl_FragColor = vec4(col, 1.0);
            }`,
            
            // 4: Kaleidoscope
            `precision highp float;
            uniform vec2 resolution;
            uniform float time, bass, mid, treble, zoom, rotation, colorShift, saturation, brightness, contrast, complexity, intensity;
            
            void main() {
                vec2 uv = (gl_FragCoord.xy - resolution.xy * 0.5) / resolution.y;
                uv /= (zoom * 1.5 + bass * 0.5);
                float dist = length(uv);
                float angle = atan(uv.y, uv.x);
                float segments = 4.0 + complexity * 12.0;
                angle = mod(angle, 6.28 / segments);
                angle = abs(angle - 3.14 / segments);
                angle += time * zoom * rotation + mid * 0.5;
                vec2 kaleido = vec2(cos(angle), sin(angle)) * dist;
                float pattern = sin(dist * 20.0 - time * 3.0 + bass * 5.0);
                pattern += sin(angle * 12.0 + time * 2.0 + mid * 3.0);
                pattern += sin(kaleido.x * 15.0 + kaleido.y * 15.0 + treble);
                pattern *= intensity;
                vec3 col = vec3(
                    sin(pattern + colorShift * 6.28) * saturation + 0.5,
                    sin(pattern + colorShift * 6.28 + 2.09) * saturation + 0.5,
                    sin(pattern + colorShift * 6.28 + 4.19) * saturation + 0.5
                );
                col *= brightness * (1.2 - dist * 0.4);
                col = mix(vec3(0.5), col, contrast);
                col += bass * 0.4 * vec3(1.0, 0.7, 0.9);
                gl_FragColor = vec4(col, 1.0);
            }`,
            
            // 5: Warp Speed
            `precision highp float;
            uniform vec2 resolution;
            uniform float time, bass, mid, treble, zoom, rotation, colorShift, saturation, brightness, contrast, complexity;
            
            float hash(vec2 p) {
                return fract(sin(dot(p, vec2(127.1, 311.7))) * 43758.5453);
            }
            
            void main() {
                vec2 uv = (gl_FragCoord.xy - resolution.xy * 0.5) / resolution.y;
                float angle = rotation * 3.14 + time * 0.5;
                float c = cos(angle), s = sin(angle);
                uv = vec2(uv.x * c - uv.y * s, uv.x * s + uv.y * c);
                vec3 col = vec3(0.0);
                float speed = zoom * 3.0 + bass * 2.0;
                
                for(float i = 0.0; i < 100.0; i++) {
                    if(i >= 30.0 + complexity * 70.0) break;
                    vec2 starPos = vec2(hash(vec2(i, 0.0)) - 0.5, hash(vec2(i, 1.0)) - 0.5) * 3.0;
                    float depth = hash(vec2(i, 2.0));
                    float z = mod(depth - time * speed * 0.5, 1.0);
                    vec2 pos = starPos / z;
                    float stretch = speed * (1.0 - z) * 0.3;
                    vec2 diff = uv - pos;
                    float streak = length(vec2(diff.x, diff.y / (1.0 + stretch)));
                    float bright = 0.002 / streak * (1.0 - z);
                    vec3 starCol = vec3(
                        sin(i * 0.1 + colorShift * 6.28 + bass) * saturation + 0.5,
                        sin(i * 0.13 + mid) * saturation + 0.5,
                        sin(i * 0.17 + treble) * saturation + 0.5
                    );
                    col += starCol * bright;
                }
                
                col *= brightness;
                col = mix(vec3(0.5), col, contrast);
                gl_FragColor = vec4(col, 1.0);
            }`,
            
            // 6: Energy Field
            `precision highp float;
            uniform vec2 resolution;
            uniform float time, bass, mid, treble, zoom, rotation, colorShift, saturation, brightness, contrast, complexity, intensity;
            
            void main() {
                vec2 uv = (gl_FragCoord.xy - resolution.xy * 0.5) / resolution.y;
                uv *= 2.0 / zoom;
                float field = 0.0;
                
                for(float i = 0.0; i < 10.0; i++) {
                    if(i >= 3.0 + complexity * 7.0) break;
                    vec2 p = vec2(sin(time * (i + 1.0) * 0.3 + bass), cos(time * (i + 1.0) * 0.2 + mid)) * 0.5;
                    float d = length(uv - p);
                    field += (sin(d * 10.0 - time * 2.0 + treble * 3.0) * 0.5 + 0.5) / (d * 10.0 + 1.0);
                }
                
                field *= intensity;
                vec3 col = vec3(
                    sin(field * 3.0 + colorShift * 6.28 + time) * saturation + 0.5,
                    sin(field * 3.0 + colorShift * 6.28 + 2.09) * saturation + 0.5,
                    sin(field * 3.0 + colorShift * 6.28 + 4.19) * saturation + 0.5
                );
                
                col *= brightness;
                col = mix(vec3(0.5), col, contrast);
                gl_FragColor = vec4(col, 1.0);
            }`,
            
            // 7: Vortex
            `precision highp float;
            uniform vec2 resolution;
            uniform float time, bass, mid, treble, zoom, rotation, colorShift, saturation, brightness, contrast, complexity, intensity;
            
            void main() {
                vec2 uv = (gl_FragCoord.xy - resolution.xy * 0.5) / resolution.y;
                float dist = length(uv);
                float angle = atan(uv.y, uv.x);
                
                float vortex = angle + sin(dist * 5.0 * complexity - time * zoom * 2.0 + bass * 3.0) * intensity;
                vortex += cos(dist * 8.0 + time + mid * 2.0) * rotation;
                
                vec3 col = vec3(
                    sin(vortex * 4.0 + dist * 10.0 + colorShift * 6.28) * saturation + 0.5,
                    sin(vortex * 4.0 + dist * 10.0 + colorShift * 6.28 + 2.09) * saturation + 0.5,
                    sin(vortex * 4.0 + dist * 10.0 + colorShift * 6.28 + 4.19) * saturation + 0.5
                );
                
                col *= brightness * (1.0 - dist * 0.6);
                col = mix(vec3(0.5), col, contrast);
                col += bass * 0.3;
                
                gl_FragColor = vec4(col, 1.0);
            }`
        ];

        // Compile shaders
        const programs = [];
        const vertexShaderSource = `attribute vec2 position; void main() { gl_Position = vec4(position, 0.0, 1.0); }`;
        const vertexShader = gl.createShader(gl.VERTEX_SHADER);
        gl.shaderSource(vertexShader, vertexShaderSource);
        gl.compileShader(vertexShader);

        advancedShaders.forEach((fragSource) => {
            const fragmentShader = gl.createShader(gl.FRAGMENT_SHADER);
            gl.shaderSource(fragmentShader, fragSource);
            gl.compileShader(fragmentShader);
            
            if (!gl.getShaderParameter(fragmentShader, gl.COMPILE_STATUS)) {
                console.error('Shader error:', gl.getShaderInfoLog(fragmentShader));
            }
            
            const program = gl.createProgram();
            gl.attachShader(program, vertexShader);
            gl.attachShader(program, fragmentShader);
            gl.linkProgram(program);
            
            programs.push({
                program: program,
                uniforms: {
                    resolution: gl.getUniformLocation(program, 'resolution'),
                    time: gl.getUniformLocation(program, 'time'),
                    bass: gl.getUniformLocation(program, 'bass'),
                    mid: gl.getUniformLocation(program, 'mid'),
                    treble: gl.getUniformLocation(program, 'treble'),
                    zoom: gl.getUniformLocation(program, 'zoom'),
                    rotation: gl.getUniformLocation(program, 'rotation'),
                    colorShift: gl.getUniformLocation(program, 'colorShift'),
                    saturation: gl.getUniformLocation(program, 'saturation'),
                    brightness: gl.getUniformLocation(program, 'brightness'),
                    contrast: gl.getUniformLocation(program, 'contrast'),
                    complexity: gl.getUniformLocation(program, 'complexity'),
                    intensity: gl.getUniformLocation(program, 'intensity'),
                    detail: gl.getUniformLocation(program, 'detail')
                }
            });
        });

        const positions = new Float32Array([-1, -1, 1, -1, -1, 1, 1, 1]);
        const buffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, buffer);
        gl.bufferData(gl.ARRAY_BUFFER, positions, gl.STATIC_DRAW);

        // FIXED AUDIO SETUP - Connect Meyda to source, not analyser
        function setupAudio(arrayBuffer) {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            analyser.fftSize = 4096; // Higher resolution
            analyser.smoothingTimeConstant = 0.75;
            
            audioContext.decodeAudioData(arrayBuffer, (buffer) => {
                audioBuffer = buffer;
                uploadArea.classList.add('hidden');
                controls.classList.add('show');
                sceneInfo.classList.add('show');
                analysisPanel.classList.add('show');
                
                document.getElementById('sceneTitle').textContent = 'Ready to Play';
                document.getElementById('sceneDesc').textContent = `${buffer.duration.toFixed(1)}s ‚Ä¢ ${buffer.numberOfChannels} channels`;
            });
        }

        function play() {
            if (!audioBuffer) return;
            
            if (isPlaying) {
                if (source) source.stop();
                isPlaying = false;
                playBtn.textContent = '‚ñ∂Ô∏è Play';
                if (meydaAnalyzer) meydaAnalyzer.stop();
                document.getElementById('sceneTitle').textContent = 'Paused';
                return;
            }
            
            source = audioContext.createBufferSource();
            source.buffer = audioBuffer;
            source.connect(analyser);
            analyser.connect(audioContext.destination);
            
            // FIXED: Connect Meyda to the source node directly
            if (typeof Meyda !== 'undefined' && !meydaAnalyzer) {
                console.log('üéµ Initializing Meyda analyzer...');
                meydaAnalyzer = Meyda.createMeydaAnalyzer({
                    audioContext: audioContext,
                    source: source,  // <-- THIS IS THE FIX
                    bufferSize: 2048,
                    featureExtractors: ['rms', 'energy', 'spectralCentroid', 'spectralFlux', 
                                       'zcr', 'chroma', 'loudness'],
                    callback: (features) => {
                        audioFeatures.rms = features.rms || 0;
                        audioFeatures.energy = features.energy || 0;
                        audioFeatures.spectralCentroid = features.spectralCentroid || 0;
                        audioFeatures.spectralFlux = features.spectralFlux || 0;
                        audioFeatures.zcr = features.zcr || 0;
                        audioFeatures.chroma = features.chroma || [];
                        
                        // Update UI with smooth animations
                        document.getElementById('rmsValue').textContent = (features.rms * 100).toFixed(1) + '%';
                        document.getElementById('energyValue').textContent = (features.energy * 100).toFixed(1) + '%';
                        document.getElementById('brightnessValue').textContent = (features.spectralCentroid / 50).toFixed(0) + ' Hz';
                        document.getElementById('fluxValue').textContent = (features.spectralFlux * 10).toFixed(2);
                        
                        // Detect key from chroma
                        if (features.chroma && features.chroma.length === 12) {
                            const maxIdx = features.chroma.indexOf(Math.max(...features.chroma));
                            const keys = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
                            document.getElementById('keyValue').textContent = keys[maxIdx];
                        }
                    }
                });
                meydaAnalyzer.start();
                console.log('‚úÖ Meyda analyzer started!');
            }
            
            source.start();
            isPlaying = true;
            playBtn.textContent = '‚è∏Ô∏è Pause';
            startTime = audioContext.currentTime;
            document.getElementById('sceneTitle').textContent = 'üéµ Playing';
            document.getElementById('sceneDesc').textContent = 'Audio analysis active';
            
            source.onended = () => {
                isPlaying = false;
                playBtn.textContent = '‚ñ∂Ô∏è Play';
                document.getElementById('sceneTitle').textContent = 'Finished';
                if (meydaAnalyzer) {
                    meydaAnalyzer.stop();
                    meydaAnalyzer = null; // Reset for next play
                }
            };
        }

        playBtn.addEventListener('click', play);

        // Beat detection
        let lastBeatInterval = 0;
        function detectBeat(bass) {
            const now = performance.now();
            beatHistory.push(bass);
            if (beatHistory.length > 30) beatHistory.shift();
            const avg = beatHistory.reduce((a, b) => a + b, 0) / beatHistory.length;
            const threshold = avg * (1.0 + params.beatSensitivity);
            
            if (bass > threshold && now - lastBeat > 300) {
                // Calculate interval BEFORE updating lastBeat
                const interval = now - lastBeat;
                lastBeat = now;
                
                // Estimate tempo from interval
                if (interval > 200 && interval < 2000) {
                    lastBeatInterval = interval;
                    const bpm = 60000 / interval;
                    audioFeatures.tempo = Math.round(bpm * 0.3 + audioFeatures.tempo * 0.7);
                    document.getElementById('tempoValue').textContent = audioFeatures.tempo + ' BPM';
                }
                
                // Flash scene indicator on beat
                const sceneProgress = document.getElementById('sceneProgress');
                sceneProgress.style.backgroundColor = '#f093fb';
                setTimeout(() => {
                    sceneProgress.style.backgroundColor = '';
                }, 100);
                
                return true;
            }
            return false;
        }

        // Recording
        let captureStream;
        function startRecording() {
            recordedChunks = [];
            captureStream = canvas.captureStream(60);
            const audioStream = audioContext.createMediaStreamDestination();
            analyser.connect(audioStream);
            captureStream.addTrack(audioStream.stream.getAudioTracks()[0]);
            
            mediaRecorder = new MediaRecorder(captureStream, {
                mimeType: 'video/webm;codecs=vp9',
                videoBitsPerSecond: 12000000
            });
            
            mediaRecorder.ondataavailable = (e) => {
                if (e.data.size > 0) recordedChunks.push(e.data);
            };
            
            mediaRecorder.onstop = () => {
                const blob = new Blob(recordedChunks, { type: 'video/webm' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `music-video-${Date.now()}.webm`;
                downloadBtn.onclick = () => a.click();
                downloadBtn.style.display = 'block';
                recordBtn.classList.remove('recording');
                recordBtn.textContent = '‚è∫Ô∏è Record';
            };
            
            mediaRecorder.start();
            recordBtn.classList.add('recording');
            recordBtn.textContent = '‚èπÔ∏è Stop';
            play();
        }

        recordBtn.addEventListener('click', () => {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
            } else {
                startRecording();
            }
        });

        // Main render loop
        function render() {
            const dataArray = new Uint8Array(analyser ? analyser.frequencyBinCount : 256);
            if (analyser) analyser.getByteFrequencyData(dataArray);
            
            // Extract frequency bands with audio reactivity multipliers
            const bass = dataArray.slice(0, 30).reduce((a, b) => a + b, 0) / 30 / 255 * params.bassReact;
            const mid = dataArray.slice(30, 120).reduce((a, b) => a + b, 0) / 90 / 255 * params.midReact;
            const treble = dataArray.slice(120, 256).reduce((a, b) => a + b, 0) / 136 / 255 * params.trebleReact;
            
            audioFeatures.bass = bass;
            audioFeatures.mid = mid;
            audioFeatures.treble = treble;
            
            if (isPlaying) {
                currentTime = audioContext.currentTime - startTime;
                detectBeat(bass);
            }
            
            // Render shader
            const currentProgram = programs[currentScene];
            gl.useProgram(currentProgram.program);
            
            const posLoc = gl.getAttribLocation(currentProgram.program, 'position');
            gl.enableVertexAttribArray(posLoc);
            gl.vertexAttribPointer(posLoc, 2, gl.FLOAT, false, 0, 0);
            
            gl.uniform2f(currentProgram.uniforms.resolution, canvas.width, canvas.height);
            gl.uniform1f(currentProgram.uniforms.time, performance.now() / 1000);
            gl.uniform1f(currentProgram.uniforms.bass, bass);
            gl.uniform1f(currentProgram.uniforms.mid, mid);
            gl.uniform1f(currentProgram.uniforms.treble, treble);
            gl.uniform1f(currentProgram.uniforms.zoom, params.zoomSpeed + bass * 0.3);
            gl.uniform1f(currentProgram.uniforms.rotation, params.rotation);
            gl.uniform1f(currentProgram.uniforms.colorShift, params.colorShift);
            gl.uniform1f(currentProgram.uniforms.saturation, params.saturation);
            gl.uniform1f(currentProgram.uniforms.brightness, params.brightness);
            gl.uniform1f(currentProgram.uniforms.contrast, params.contrast);
            gl.uniform1f(currentProgram.uniforms.complexity, params.complexity);
            gl.uniform1f(currentProgram.uniforms.intensity, params.intensity);
            gl.uniform1f(currentProgram.uniforms.detail, params.detail);
            
            gl.drawArrays(gl.TRIANGLE_STRIP, 0, 4);
            
            // Update visualizer
            const bars = document.querySelectorAll('.freq-bar');
            if (bars.length > 0 && visualizer.classList.contains('show')) {
                for (let i = 0; i < Math.min(bars.length, dataArray.length); i++) {
                    const value = dataArray[i] / 255;
                    bars[i].style.height = (value * 60) + 'px';
                }
            }
            
            requestAnimationFrame(render);
        }
        render();

        // File handling
        uploadArea.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => {
            if (e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => setupAudio(e.target.result);
                reader.readAsArrayBuffer(e.target.files[0]);
            }
        });
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#667eea';
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('audio/')) {
                const reader = new FileReader();
                reader.onload = (e) => setupAudio(e.target.result);
                reader.readAsArrayBuffer(file);
            }
        });
    </script>
</body>
</html>
